<dom-module id="reddit-list">
    <template>
        <style include="shared-styles">
            ul li {
                list-style-type: none;
            }
        </style>

        <iron-ajax 
            auto
            url="[[getUrl(selectedSubreddit)]]"
            handle-as="json"
            last-response="{{redditData}}"
            ></iron-ajax>
        <iron-ajax 
            auto
            url="https://www.reddit.com/api/subreddits_by_topic.json?query=karma"
            handle-as="json"
            last-response="{{subredditsList}}"
            loading="{{subredditsLoading}}"
            ></iron-ajax>

        <h2>[[selectedSubreddit]]</h2>
        <paper-spinner-lite active="[[subredditsLoading]]"></paper-spinner-lite>
        <paper-dropdown-menu label="Pick a subreddit" on-iron-select="itemSelected">
            <paper-listbox class="dropdown-content" selected="{{selectedSubreddit}}" attr-for-selected="name">
                <dom-repeat items="[[subredditsList]]">
                    <template>
                        <paper-item name="[[item.name]]">[[item.name]]</paper-item>
                    </template>
                </dom-repeat>
            </paper-listbox>
        </paper-dropdown-menu>
        
        <ul>
            <dom-repeat items="[[redditData.data.children]]" as="redditPost">
            <template>
                <li>
                    <ul>
                        <li><p>[[redditPost.data.author]]</p></li>
                        <li><a href="/reddit-detail/[[redditPost.kind]]_[[redditPost.data.id]]"><h3>[[redditPost.data.title]]</h3></a></li>
                        <!--TODO: Remove that crappy array function-->
                        <li><iron-image style="width:400px; height:400px;" sizing="cover" src="[[arrayItem(redditPost.data.preview.images, 0)]]"></iron-image></li>
                        <li>[[redditPost.data.score]]</li>
                    </ul>
                    <hr>
                </li>
            </template>
            </dom-repeat>
        </ul>
    </template>
    <script>
    class RedditList extends Polymer.Element {
        static get is() { return "reddit-list"; }
        arrayify(obj) {
            return Object.entries(obj)
        }
        itemSelected(e) {
            console.log("selected: " + e.target.selectedItem.name);
        }
        arrayItem(array, index) {
            if (array == undefined) {
                return '../media/reddit-logo.png'
            } else {
                return array[index].source.url
            }
        }
        getUrl(subreddit){
            return `https://api.reddit.com/r/${subreddit}?limit=20`
        }
        hyphenate(obj) {
            return obj.replace(/(?!\[^.]+$)\.|[^\w.]+/g, '-').toLowerCase()
        }
    }
    customElements.define(RedditList.is, RedditList)
    </script>
</dom-module>